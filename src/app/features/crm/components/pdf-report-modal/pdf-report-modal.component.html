<!-- Modal Overlay -->
<div *ngIf="isOpen" class="modal-overlay" (click)="close()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Botón cerrar flotante -->
    <button class="close-button-floating" (click)="close()" aria-label="Cerrar">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
        <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.758 17.243L12.001 12m5.243-5.243L12 12m0 0L6.758 6.757M12.001 12l5.243 5.243"/>
      </svg>
    </button>

    <!-- Modal Body - PDF Preview -->
    <div class="modal-body">
      <div class="pdf-preview-container">
        <!-- Contenido del PDF -->
        <div id="pdf-content" class="pdf-content">
          <!-- Header del Reporte -->
          <div class="report-header">
            <div class="header-left">
              <div class="logo-container">
                <img src="assets/logo/logo-corto.png" alt="Oceanix Logo" class="company-logo" />
              </div>
            </div>
            <div class="header-right">
              <div class="midas-badge">
                <h1>REPORTE</h1>
                <div class="subtitle">GESTIÓN DE INCIDENCIAS</div>
                <div class="year">{{ currentDate.getFullYear() }}</div>
              </div>
            </div>
          </div>

          <!-- Main Title -->
          <div class="main-title">
            <h2>RESULTADOS</h2>
            <p class="subtitle-section">SISTEMA DE GESTIÓN DE INCIDENCIAS</p>
          </div>

          <!-- Content Grid -->
          <div class="content-grid">
            <!-- Left Column -->
            <div class="left-column">
              <!-- Estadísticas Principales -->
              <div class="section-card stats-card">
                <div class="section-header">
                  <div class="icon-badge icon-stats">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                      <path fill="currentColor" d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                    </svg>
                  </div>
                  <h3>ESTADÍSTICAS 2025</h3>
                </div>

                <div class="stats-content" *ngIf="dashboardData">
                  <div class="stat-item-large">
                    <p class="stat-label">Total de incidencias registradas</p>
                    <h2 class="stat-value-large">
                      {{ dashboardData.stats.totalIncidencias.total }}
                    </h2>
                  </div>

                  <div class="stats-grid-mini">
                    <div class="mini-stat">
                      <div class="mini-stat-icon resolved">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                          <path fill="white" d="M9 16.17L4.83 12l-1.42 1.41L9 19L21 7l-1.41-1.41L9 16.17z"/>
                        </svg>
                      </div>
                      <div class="mini-stat-value">
                        {{ dashboardData.stats.incidenciasResueltas.total }}
                      </div>
                      <div class="mini-stat-label">Resueltas</div>
                    </div>

                    <div class="mini-stat">
                      <div class="mini-stat-icon pending">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                          <path fill="white" d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10s10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8zm.5-13H11v6l5.2 3.2l.8-1.3l-4.5-2.7V7z"/>
                        </svg>
                      </div>
                      <div class="mini-stat-value">
                        {{ dashboardData.stats.pendientes.total }}
                      </div>
                      <div class="mini-stat-label">Pendientes</div>
                    </div>
                  </div>

                  <div class="tiempo-promedio">
                    <div class="tiempo-label">Tiempo promedio de resolución</div>
                    <div class="tiempo-value">
                      <span class="numero">{{ dashboardData.stats.tiempoPromedio.dias }}</span>
                      <span class="unidad">días</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Incidencias por Tipo -->
              <div class="section-card chart-card">
                <div class="section-header">
                  <div class="icon-badge icon-chart">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                      <path fill="currentColor" d="M5 9.2h3V19H5V9.2zM10.6 5h2.8v14h-2.8V5zm5.6 8H19v6h-2.8v-6z"/>
                    </svg>
                  </div>
                  <h3>INCIDENCIAS POR TIPO</h3>
                </div>

                <div class="apex-chart-container" *ngIf="barChartOptions">
                  <apx-chart
                    [series]="barChartOptions.series!"
                    [chart]="barChartOptions.chart!"
                    [dataLabels]="barChartOptions.dataLabels!"
                    [plotOptions]="barChartOptions.plotOptions!"
                    [xaxis]="barChartOptions.xaxis!"
                    [yaxis]="barChartOptions.yaxis!"
                    [grid]="barChartOptions.grid!"
                    [fill]="barChartOptions.fill!"
                    [colors]="barChartOptions.colors!"
                  ></apx-chart>
                </div>
              </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
              <!-- Mapa / Gráfico Circular -->
              <div class="section-card donut-card">
                <div class="section-header-small">
                  <h4>DISTRIBUCIÓN DE ESTADOS</h4>
                </div>

                <div class="apex-chart-container-donut" *ngIf="pieChartOptions">
                  <apx-chart
                    [series]="pieChartOptions.series!"
                    [chart]="pieChartOptions.chart!"
                    [labels]="pieChartOptions.labels!"
                    [colors]="pieChartOptions.colors!"
                    [legend]="pieChartOptions.legend!"
                    [dataLabels]="pieChartOptions.dataLabels!"
                    [plotOptions]="pieChartOptions.plotOptions!"
                  ></apx-chart>
                </div>
              </div>

              <!-- Resumen de Métricas -->
              <div class="section-card metrics-summary">
                <div class="section-header-small">
                  <h4>MÉTRICAS CLAVE</h4>
                </div>

                <div class="metrics-list" *ngIf="dashboardData">
                  <div class="metric-row">
                    <span class="metric-label">Tasa de resolución</span>
                    <span class="metric-value success">
                      {{
                        (dashboardData.stats.incidenciasResueltas.total /
                          dashboardData.stats.totalIncidencias.total) *
                          100 | number: '1.1-1'
                      }}%
                    </span>
                  </div>

                  <div class="metric-row">
                    <span class="metric-label">Incidencias críticas</span>
                    <span class="metric-value critical">
                      {{ getCriticasPercentage() }}%
                    </span>
                  </div>

                  <div class="metric-row">
                    <span class="metric-label">Eficiencia operativa</span>
                    <span class="metric-value success">Alta</span>
                  </div>

                  <div class="metric-row">
                    <span class="metric-label">Tendencia mensual</span>
                    <span class="metric-value">
                      {{ dashboardData.stats.totalIncidencias.cambio }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Información Adicional -->
              <div class="section-card info-card">
                <div class="section-header-small">
                  <h4>INFORMACIÓN DEL REPORTE</h4>
                </div>

                <div class="info-list">
                  <div class="info-item">
                    <svg class="info-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                      <path fill="currentColor" d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8 4H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/>
                    </svg>
                    <div>
                      <div class="info-label">Fecha de generación</div>
                      <div class="info-value">{{ currentDate | date: 'dd/MM/yyyy' }}</div>
                    </div>
                  </div>

                  <div class="info-item">
                    <svg class="info-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                      <path fill="currentColor" d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                    </svg>
                    <div>
                      <div class="info-label">Período</div>
                      <div class="info-value">Enero - Noviembre {{ currentDate.getFullYear() }}</div>
                    </div>
                  </div>

                  <div class="info-item">
                    <svg class="info-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                      <path fill="currentColor" d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/>
                    </svg>
                    <div>
                      <div class="info-label">Sistema</div>
                      <div class="info-value">Oceanix CRM v1.0</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer -->
          <div class="report-footer">
            <p>Generado por: Oceanix CRM | Sistema de Gestión de Incidencias | {{ currentDate.getFullYear() }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="close()" [disabled]="isGenerating">
        Cancelar
      </button>
      <button
        class="btn btn-primary"
        (click)="downloadPdf()"
        [disabled]="isGenerating"
      >
        <svg
          *ngIf="!isGenerating"
          width="20"
          height="20"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path d="M12 4v12m0 0l-4-4m4 4l4-4M4 20h16" />
        </svg>
        <svg
          *ngIf="isGenerating"
          class="spinner"
          width="20"
          height="20"
          viewBox="0 0 24 24"
        >
          <circle
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
            fill="none"
            opacity="0.25"
          />
          <path
            fill="currentColor"
            d="M12 2a10 10 0 0 1 10 10h-4a6 6 0 0 0-6-6V2z"
            opacity="0.75"
          />
        </svg>
        {{ isGenerating ? 'Generando...' : 'Descargar PDF' }}
      </button>
    </div>
  </div>
</div>
