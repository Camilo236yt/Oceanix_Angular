<div class="h-screen bg-gray-50 overflow-hidden flex flex-col p-4 sm:p-4 md:p-4">
  <!-- Header superior con icono -->
  <div class="bg-header-purple px-3 py-2.5 sm:px-6 sm:py-4 flex items-center justify-between rounded-2xl shadow-sm mb-2 sm:mb-3">
    <!-- Logo izquierda -->
    <div class="flex-shrink-0">
      <img src="assets/logo/logo-corto.png" alt="Logo" class="h-8 sm:h-14 w-auto">
    </div>

    <!-- Texto centrado -->
    <div class="flex-1 text-center px-2 min-w-0">
      <h1 class="text-sm sm:text-xl font-bold text-gray-900 truncate">Registrar Incidencia</h1>
      <p class="text-[10px] sm:text-xs text-gray-600 mt-0.5 hidden sm:block">Completa el formulario con los detalles de tu incidencia</p>
    </div>

    <!-- Iconos derecha - Mobile y Desktop -->
    <div class="flex items-center gap-1.5 sm:gap-2 flex-shrink-0">
      <!-- Historial (solo mobile) -->
      <button
        (click)="abrirHistorialMobile()"
        class="md:hidden flex-shrink-0 p-1.5 bg-white rounded-xl shadow-sm relative hover:bg-gray-50 active:scale-95 transition-all"
      >
        <!-- Icono de reloj/historial -->
        <svg class="w-5 h-5 text-oceanix-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <!-- Badge con número de incidencias -->
        @if (incidencias.length > 0) {
          <span class="absolute -top-1 -right-1 bg-oceanix-purple-600 text-white text-[9px] font-bold rounded-full w-4 h-4 flex items-center justify-center">
            {{ incidencias.length }}
          </span>
        }
      </button>

      <!-- Icono desktop -->
      <div class="hidden md:flex flex-shrink-0 p-2.5 bg-white rounded-xl shadow-sm">
        <svg class="w-7 h-7 text-oceanix-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
      </div>

      <!-- Notificaciones -->
      <div class="relative">
        <app-notifications-dropdown
          [notifications]="clientNotificationsService.notifications()"
          [(isOpen)]="isNotificationDropdownOpen"
          (notificationClick)="onNotificationClick($event)"
          (markAsRead)="onMarkNotificationAsRead($event)"
          (markAllAsRead)="onMarkAllNotificationsAsRead()"
          (deleteNotification)="onDeleteNotification($event)">
        </app-notifications-dropdown>
      </div>
    </div>
  </div>

  <!-- Grid principal: Formulario + Historial -->
  <div class="flex-1 grid transition-all duration-300 overflow-hidden grid-cols-1 md:grid-cols-[58%_42%]">

    <!-- COLUMNA IZQUIERDA: FORMULARIO -->
    <div class="h-full overflow-y-auto px-2 sm:px-4 py-1 sm:py-2">
      <form [formGroup]="incidenciaForm" (ngSubmit)="enviarIncidencia()" class="space-y-2 sm:space-y-2.5">

        <!-- Sección 1: Nombre de la Incidencia -->
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 border border-gray-200">
          <div class="flex items-center gap-2 mb-2 sm:mb-3">
            <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-oceanix-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            <h2 class="text-xs sm:text-sm font-semibold text-gray-900">Nombre de la Incidencia</h2>
          </div>

          <div>
            <label class="block text-[11px] sm:text-xs font-medium text-gray-700 mb-1 sm:mb-1.5">
              Nombre <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              formControlName="nombreIncidencia"
              placeholder="Ej: Paquete dañado en transporte"
              class="w-full px-2.5 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm bg-white border rounded-lg focus:ring-1 focus:ring-purple-500 focus:border-transparent text-gray-900 placeholder-gray-400 transition-all outline-none"
              [ngClass]="{'border-red-500': isFieldInvalid('nombreIncidencia'), 'border-gray-300': !isFieldInvalid('nombreIncidencia')}"
            />
            @if (isFieldInvalid('nombreIncidencia')) {
              <p class="mt-1 text-[10px] sm:text-xs text-red-500">{{ getFieldError('nombreIncidencia') }}</p>
            }
          </div>
        </div>

        <!-- Sección 2: Detalles de Incidencia -->
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 border border-gray-200">
          <div class="flex items-center gap-2 mb-2 sm:mb-3">
            <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-oceanix-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <h2 class="text-xs sm:text-sm font-semibold text-gray-900">Detalles de Incidencia</h2>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
            <div>
              <label class="block text-[11px] sm:text-xs font-medium text-gray-700 mb-1 sm:mb-1.5">
                Número de Guía <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                formControlName="numeroGuia"
                placeholder="DU-1234567890"
                class="w-full px-2.5 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm bg-white border rounded-lg focus:ring-1 focus:ring-purple-500 focus:border-transparent text-gray-900 placeholder-gray-400 transition-all outline-none"
                [ngClass]="{'border-red-500': isFieldInvalid('numeroGuia'), 'border-gray-300': !isFieldInvalid('numeroGuia')}"
              />
              @if (isFieldInvalid('numeroGuia')) {
                <p class="mt-1 text-[10px] sm:text-xs text-red-500">{{ getFieldError('numeroGuia') }}</p>
              }
            </div>

            <div>
              <label class="block text-[11px] sm:text-xs font-medium text-gray-700 mb-1 sm:mb-1.5">
                Tipo de Incidencia <span class="text-red-500">*</span>
              </label>
              <select
                formControlName="tipoIncidencia"
                class="w-full px-2.5 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm bg-white border rounded-lg focus:ring-1 focus:ring-purple-500 focus:border-transparent text-gray-900 transition-all outline-none appearance-none"
                [ngClass]="{'border-red-500': isFieldInvalid('tipoIncidencia'), 'border-gray-300': !isFieldInvalid('tipoIncidencia')}"
              >
                <option value="">Selecciona tipo</option>
                <option value="por_dano">Daño</option>
                <option value="por_perdida">Pérdida</option>
                <option value="por_error_humano">Error Humano</option>
                <option value="por_mantenimiento">Mantenimiento</option>
                <option value="por_falla_tecnica">Falla Técnica</option>
                <option value="otro">Otro</option>
              </select>
              @if (isFieldInvalid('tipoIncidencia')) {
                <p class="mt-1 text-[10px] sm:text-xs text-red-500">{{ getFieldError('tipoIncidencia') }}</p>
              }
            </div>
          </div>
        </div>

        <!-- Sección 3: Evidencia y Descripción -->
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 border border-gray-200">
          <div class="flex items-center gap-2 mb-2 sm:mb-3">
            <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-oceanix-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <h2 class="text-xs sm:text-sm font-semibold text-gray-900">Evidencia y Descripción</h2>
          </div>

          <div class="space-y-2 sm:space-y-3">
            <!-- Upload de imágenes múltiples -->
            <div>
              <label class="block text-[11px] sm:text-xs font-medium text-gray-700 mb-1 sm:mb-1.5">
                Fotos de Evidencia (Opcional - Máx. 5)
              </label>

              <!-- Grid de imágenes seleccionadas -->
              @if (imagenesPreview.length > 0) {
                <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 mb-2">
                  @for (preview of imagenesPreview; track $index) {
                    <div class="relative group aspect-square">
                      @if (preview) {
                        <img
                          [src]="preview"
                          alt="Preview"
                          class="w-full h-full object-cover rounded-lg border border-gray-200"
                        />
                      } @else {
                        <!-- Indicador de carga mientras se procesa la imagen -->
                        <div class="w-full h-full rounded-lg border border-gray-200 bg-gray-100 flex items-center justify-center">
                          <svg class="w-5 h-5 text-gray-400 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                          </svg>
                        </div>
                      }
                      <!-- Botón eliminar -->
                      <button
                        type="button"
                        (click)="eliminarImagen($index)"
                        class="absolute -top-1.5 -right-1.5 w-5 h-5 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center shadow-md transition-all opacity-0 group-hover:opacity-100 sm:opacity-100"
                      >
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                      </button>
                    </div>
                  }

                  <!-- Botón agregar más (si no se alcanzó el límite) -->
                  @if (archivosSeleccionados.length < MAX_IMAGENES) {
                    <label class="aspect-square flex flex-col items-center justify-center border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-all">
                      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                      </svg>
                      <input type="file" class="hidden" accept="image/png,image/jpeg,image/jpg,image/webp" multiple (change)="onFileSelected($event)" />
                    </label>
                  }
                </div>
                <p class="text-[9px] sm:text-[10px] text-gray-500">{{ archivosSeleccionados.length }} de {{ MAX_IMAGENES }} imágenes</p>
              } @else {
                <!-- Estado inicial sin imágenes -->
                <label class="flex flex-col items-center justify-center w-full h-16 sm:h-20 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-all">
                  <div class="flex flex-col items-center justify-center">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6 mb-0.5 sm:mb-1 text-oceanix-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p class="text-[10px] sm:text-xs text-gray-500"><span class="font-semibold">Subir imágenes</span></p>
                    <p class="text-[9px] sm:text-[10px] text-gray-400">PNG, JPG, WEBP hasta 5MB</p>
                  </div>
                  <input type="file" class="hidden" accept="image/png,image/jpeg,image/jpg,image/webp" multiple (change)="onFileSelected($event)" />
                </label>
              }
            </div>

            <!-- Descripción compacta -->
            <div>
              <label class="block text-[11px] sm:text-xs font-medium text-gray-700 mb-1 sm:mb-1.5">
                Descripción Detallada <span class="text-red-500">*</span>
              </label>
              <textarea
                formControlName="descripcion"
                rows="2"
                placeholder="Describe detalladamente lo sucedido con tu envío..."
                class="w-full px-2.5 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm bg-white border rounded-lg focus:ring-1 focus:ring-purple-500 focus:border-transparent text-gray-900 placeholder-gray-400 resize-none transition-all outline-none"
                [ngClass]="{'border-red-500': isFieldInvalid('descripcion'), 'border-gray-300': !isFieldInvalid('descripcion')}"
              ></textarea>
              @if (isFieldInvalid('descripcion')) {
                <p class="mt-1 text-[10px] sm:text-xs text-red-500">{{ getFieldError('descripcion') }}</p>
              }
            </div>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 pt-1 sm:pt-2">
          <button
            type="submit"
            class="flex-1 flex items-center justify-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-2 sm:py-2.5 bg-oceanix-purple-600 hover:bg-oceanix-purple-700 text-white text-xs sm:text-sm font-semibold rounded-lg shadow-md hover:shadow-lg transition-all"
          >
            <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Enviar Incidencia
          </button>
          <button
            type="button"
            (click)="cancelar()"
            class="px-3 sm:px-4 py-2 sm:py-2.5 bg-white border-2 border-gray-300 text-gray-700 text-xs sm:text-sm font-semibold rounded-lg hover:bg-gray-50 transition-all"
          >
            Cancelar
          </button>
        </div>
      </form>

      <!-- Footer de ayuda compacto -->
      <div class="mt-2 sm:mt-3 pt-2 sm:pt-3 border-t border-gray-200 text-center">
        <p class="text-[10px] sm:text-xs text-gray-600">
          ¿Necesitas ayuda?
          <a href="tel:+573001234567" class="text-oceanix-purple-600 hover:underline font-medium ml-1">
            <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3 inline mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
            </svg>
            +57 300 123 4567
          </a>
        </p>
      </div>
    </div>

    <!-- COLUMNA DERECHA: HISTORIAL (Oculto en mobile) -->
    <div class="hidden md:flex h-full bg-white border-l border-gray-200 flex-col overflow-hidden">
      <!-- Header del historial -->
      <div class="px-4 py-3 border-b border-gray-200 bg-purple-50">
        <h2 class="text-base font-bold text-gray-900">Historial</h2>
        <p class="text-xs text-gray-600">Tus incidencias reportadas</p>
      </div>

      <!-- Lista de incidencias -->
      @if (historialVisible()) {
        <div class="flex-1 overflow-y-auto p-3 space-y-2.5">
          @if (incidencias.length > 0) {
            @for (incidencia of incidencias; track incidencia.id) {
              <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 hover:shadow-md transition-all"
                   [class.animate-remove]="removingIncidenciaId === incidencia.id">
                <!-- Header de la card -->
                <div class="flex items-center justify-between mb-2">
                  <span class="text-sm font-bold text-gray-900 truncate flex-1 mr-2">{{ incidencia.name }}</span>
                  <span class="text-[10px] text-gray-500 flex-shrink-0">{{ formatDate(incidencia.createdAt) }}</span>
                </div>

                <!-- Estado -->
                <div class="mb-2">
                  <span
                    class="px-2 py-0.5 rounded-full text-[10px] font-semibold"
                    [ngClass]="getEstadoClass(incidencia.status)"
                  >
                    {{ getStatusLabel(incidencia.status) }}
                  </span>
                </div>

                <!-- Tipo -->
                <div class="flex items-start gap-1.5 mb-2">
                  <span class="text-[11px] font-medium text-gray-600">Tipo:</span>
                  <span class="text-[11px] text-gray-900">{{ getTipoLabel(incidencia.tipo) }}</span>
                </div>

                <!-- Botón ver detalles -->
                <button
                  (click)="verDetalles(incidencia)"
                  class="w-full text-xs text-oceanix-purple-600 hover:text-oceanix-purple-700 font-medium flex items-center justify-center gap-1 py-1.5 hover:bg-purple-50 rounded-md transition-all"
                >
                  Ver detalles
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </button>
              </div>
            }

            <!-- Mensaje footer -->
            <div class="text-center py-4">
              <p class="text-xs text-gray-500 mb-1.5">¿No encuentras tu incidencia?</p>
              <button class="text-xs text-oceanix-purple-600 hover:underline font-medium">Ver todas</button>
            </div>
          } @else {
            <!-- Estado vacío -->
            <div class="flex flex-col items-center justify-center py-12 text-center">
              <svg class="w-16 h-16 text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <p class="text-sm font-medium text-gray-900 mb-1">No hay incidencias</p>
              <p class="text-xs text-gray-500">Cuando reportes una incidencia aparecerá aquí</p>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- SLIDE PANEL MOBILE: Historial -->
  @if (panelHistorialMobileVisible()) {
    <!-- Backdrop semi-transparente -->
    <div
      class="fixed inset-0 bg-black/40 z-40 md:hidden panel-backdrop"
      [class.closing]="panelClosing()"
      (click)="cerrarHistorialMobile()"
    ></div>

    <!-- Panel lateral -->
    <div
      class="fixed top-0 right-0 bottom-0 w-[85%] max-w-sm bg-white shadow-2xl z-50 md:hidden flex flex-col slide-panel"
      [class.closing]="panelClosing()"
    >
      <!-- Header del panel -->
      <div class="flex items-center justify-between px-4 py-4 border-b border-gray-200 bg-purple-50">
        <div>
          <h2 class="text-lg font-bold text-gray-900">Mis Incidencias</h2>
          <p class="text-xs text-gray-600">Historial de reportes</p>
        </div>
        <button
          (click)="cerrarHistorialMobile()"
          class="p-2 hover:bg-gray-200 rounded-lg transition-all active:scale-95"
        >
          <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Lista de incidencias -->
      <div class="flex-1 overflow-y-auto p-3 space-y-2.5">
        @if (incidencias.length > 0) {
          @for (incidencia of incidencias; track incidencia.id) {
            <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 active:bg-gray-100 transition-all"
                 [class.animate-remove]="removingIncidenciaId === incidencia.id">
              <!-- Header de la card -->
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-bold text-gray-900 truncate flex-1 mr-2">{{ incidencia.name }}</span>
                <span class="text-[10px] text-gray-500 flex-shrink-0">{{ formatDate(incidencia.createdAt) }}</span>
              </div>

              <!-- Estado -->
              <div class="mb-2">
                <span
                  class="px-2 py-0.5 rounded-full text-[10px] font-semibold"
                  [ngClass]="getEstadoClass(incidencia.status)"
                >
                  {{ getStatusLabel(incidencia.status) }}
                </span>
              </div>

              <!-- Tipo -->
              <div class="flex items-start gap-1.5 mb-2">
                <span class="text-[11px] font-medium text-gray-600">Tipo:</span>
                <span class="text-[11px] text-gray-900">{{ getTipoLabel(incidencia.tipo) }}</span>
              </div>

              <!-- Botón ver detalles -->
              <button
                (click)="verDetalles(incidencia)"
                class="w-full text-xs text-oceanix-purple-600 hover:text-oceanix-purple-700 font-medium flex items-center justify-center gap-1 py-1.5 hover:bg-purple-50 rounded-md transition-all"
              >
                Ver detalles
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
          }
        } @else {
          <div class="flex flex-col items-center justify-center py-12 text-center">
            <svg class="w-16 h-16 text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="text-sm font-medium text-gray-900 mb-1">No tienes incidencias</p>
            <p class="text-xs text-gray-500">Cuando reportes una incidencia aparecerá aquí</p>
          </div>
        }
      </div>
    </div>
  }

  <!-- Modal Ver Detalles -->
  @if (isModalOpen()) {
    <div class="fixed inset-0 z-50 flex items-center justify-center p-0 md:p-4 bg-black/40 animate-fade-in"
         (click)="handleBackdropClick($event)">
      <!-- Modal Container -->
      <div class="bg-white md:rounded-lg shadow-xl w-full max-w-6xl animate-scale-in h-screen md:h-[90vh] flex flex-col">

        @if (selectedIncidencia) {
          <!-- Header - Con safe area para móviles -->
          <div class="flex items-center justify-between px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-100 flex-shrink-0"
               style="padding-top: max(0.75rem, env(safe-area-inset-top));">
            <h2 class="text-base sm:text-lg font-semibold text-gray-900">Detalle de Incidencia</h2>
            <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          <!-- Tabs móvil -->
          <div class="md:hidden border-b border-gray-200 flex-shrink-0">
            <div class="flex">
              <button
                (click)="switchTab('details')"
                [class]="activeTab === 'details'
                  ? 'flex-1 py-3 px-4 text-sm font-medium text-purple-600 border-b-2 border-purple-600 bg-purple-50'
                  : 'flex-1 py-3 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-colors'">
                Detalles
              </button>
              <button
                (click)="switchTab('chat')"
                [class]="activeTab === 'chat'
                  ? 'flex-1 py-3 px-4 text-sm font-medium text-purple-600 border-b-2 border-purple-600 bg-purple-50'
                  : 'flex-1 py-3 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition-colors'">
                Chat
              </button>
            </div>
          </div>

          <!-- Body - Two columns layout -->
          <div class="flex-1 overflow-hidden flex">
            <!-- Left Column - Incident Details -->
            <div [class]="activeTab === 'details'
              ? 'w-full md:w-1/2 overflow-y-auto p-4 sm:p-6'
              : 'hidden md:block md:w-1/2 overflow-y-auto p-4 sm:p-6'"
              class="md:border-r border-gray-200"
              style="padding-bottom: max(1.5rem, calc(env(safe-area-inset-bottom) + 1.5rem))!important;">
              <!-- Nombre y Nivel de Alerta -->
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h3 class="text-base sm:text-lg font-bold text-gray-900 mb-1">{{ selectedIncidencia.name }}</h3>
                  <span class="text-xs sm:text-sm text-purple-600 font-medium">{{ getTipoLabel(selectedIncidencia.tipo) }}</span>
                </div>
                <!-- Semáforo (4 niveles: GREEN -> YELLOW -> ORANGE -> RED) -->
                <div class="flex items-center gap-1 sm:gap-1.5 bg-gray-100 rounded-full px-2 sm:px-3 py-1 sm:py-1.5">
                  <div class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full"
                       [style.background-color]="selectedIncidencia.alertLevel === 'GREEN' ? '#22c55e' : '#d1d5db'"></div>
                  <div class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full"
                       [style.background-color]="selectedIncidencia.alertLevel === 'YELLOW' ? '#facc15' : '#d1d5db'"></div>
                  <div class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full"
                       [style.background-color]="selectedIncidencia.alertLevel === 'ORANGE' ? '#f97316' : '#d1d5db'"></div>
                  <div class="w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full"
                       [style.background-color]="selectedIncidencia.alertLevel === 'RED' ? '#ef4444' : '#d1d5db'"></div>
                </div>
              </div>

              <!-- Estado -->
              <div class="mb-4">
                <span class="inline-flex items-center gap-1.5 sm:gap-2 px-2.5 sm:px-3 py-1 sm:py-1.5 rounded-md text-xs sm:text-sm font-medium"
                      [ngClass]="{
                        'bg-green-50 text-green-700': selectedIncidencia.status === 'RESOLVED',
                        'bg-orange-50 text-orange-700': selectedIncidencia.status === 'IN_PROGRESS',
                        'bg-red-50 text-red-700': selectedIncidencia.status === 'PENDING',
                        'bg-blue-50 text-blue-700': selectedIncidencia.status === 'CLOSED'
                      }">
                  <span class="w-1.5 h-1.5 rounded-full"
                        [ngClass]="{
                          'bg-green-500': selectedIncidencia.status === 'RESOLVED',
                          'bg-orange-500': selectedIncidencia.status === 'IN_PROGRESS',
                          'bg-red-500': selectedIncidencia.status === 'PENDING',
                          'bg-blue-500': selectedIncidencia.status === 'CLOSED'
                        }"></span>
                  {{ getStatusLabel(selectedIncidencia.status) }}
                </span>
              </div>

              <!-- Descripción -->
              <div class="mb-4">
                <label class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wide">Descripción</label>
                <p class="mt-1 text-xs sm:text-sm text-gray-700 leading-relaxed">{{ selectedIncidencia.description || 'Sin descripción' }}</p>
              </div>

              <!-- Grid de información -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4">
                <div>
                  <label class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wide">Referencia</label>
                  <p class="mt-1 text-xs sm:text-sm text-gray-900 font-mono">{{ selectedIncidencia.ProducReferenceId || 'N/A' }}</p>
                </div>
                <div>
                  <label class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wide">Fecha de creación</label>
                  <p class="mt-1 text-xs sm:text-sm text-gray-900">{{ formatDateTime(selectedIncidencia.createdAt) }}</p>
                </div>
              </div>

              <!-- Imágenes de evidencia existentes -->
              @if (selectedIncidencia.images && selectedIncidencia.images.length > 0) {
                <div class="mb-4">
                  <label class="text-[10px] sm:text-xs font-medium text-gray-500 uppercase tracking-wide block mb-2">
                    Imágenes de Evidencia ({{ selectedIncidencia.images.length }})
                  </label>
                  <div class="grid grid-cols-2 sm:grid-cols-2 gap-2">
                    @for (image of selectedIncidencia.images; track image.id) {
                      <div class="relative group cursor-pointer rounded-lg overflow-hidden border border-gray-200 aspect-video bg-gray-100">
                        @if ((image.url | secureImage:true | async); as imageUrl) {
                          @if (imageUrl) {
                            <img [src]="imageUrl" [alt]="image.originalName" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                              <span class="text-white text-xs font-medium">Ver imagen</span>
                            </div>
                          } @else {
                            <!-- Skeleton loader -->
                            <div class="w-full h-full bg-gradient-to-r from-gray-200 via-gray-300 to-gray-200 animate-pulse">
                              <div class="w-full h-full flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                              </div>
                            </div>
                          }
                        }
                      </div>
                    }
                  </div>
                </div>
              }

              <!-- Upload de imágenes (solo si puede subir) -->
              @if (selectedIncidencia.canClientUploadImages) {
                <div class="mt-4 p-3 sm:p-4 bg-amber-50 border border-amber-200 rounded-lg">
                  <div class="flex items-center gap-2 mb-3">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span class="text-xs sm:text-sm font-medium text-amber-800">Se requiere evidencia adicional</span>
                  </div>

                  @if (modalPreviews.length > 0) {
                    <div class="grid grid-cols-3 gap-2 mb-3">
                      @for (preview of modalPreviews; track $index) {
                        <div class="relative group aspect-square">
                          <img [src]="preview" alt="Preview" class="w-full h-full object-cover rounded-lg border border-gray-200">
                          <button type="button" (click)="eliminarModalImagen($index)"
                                  class="absolute -top-1.5 -right-1.5 w-5 h-5 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center shadow-md">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                          </button>
                        </div>
                      }
                      @if (modalArchivos.length < MAX_IMAGENES) {
                        <label class="aspect-square flex items-center justify-center border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-gray-50">
                          <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                          </svg>
                          <input type="file" class="hidden" accept="image/png,image/jpeg,image/jpg,image/webp" multiple (change)="onModalFileSelected($event)" />
                        </label>
                      }
                    </div>
                    <button (click)="uploadModalImages()"
                            [disabled]="isUploadingImages"
                            class="w-full py-2 bg-amber-600 hover:bg-amber-700 disabled:opacity-50 text-white text-xs sm:text-sm font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
                      @if (isUploadingImages) {
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                      }
                      Enviar imágenes
                    </button>
                  } @else {
                    <label class="flex flex-col items-center justify-center w-full h-16 sm:h-20 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-white hover:bg-gray-50">
                      <svg class="w-5 h-5 sm:w-6 sm:h-6 mb-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                      </svg>
                      <p class="text-[10px] sm:text-xs text-gray-500"><span class="font-semibold">Subir imágenes</span></p>
                      <input type="file" class="hidden" accept="image/png,image/jpeg,image/jpg,image/webp" multiple (change)="onModalFileSelected($event)" />
                    </label>
                  }
                </div>
              }
            </div>

            <!-- Right Column - Chat -->
            <div [class]="activeTab === 'chat'
              ? 'w-full md:w-1/2 flex flex-col'
              : 'hidden md:flex md:w-1/2 flex-col'"
              class="border-t md:border-t-0 border-gray-200">
              <div class="p-3 sm:p-4 border-b border-gray-200 bg-gray-50 flex-shrink-0">
                <h3 class="text-xs sm:text-sm font-semibold text-gray-900">Conversación</h3>
                <p class="text-[10px] sm:text-xs text-gray-500">Chat con soporte</p>
              </div>

              <!-- Messages Container -->
              <div id="client-chat-messages" class="flex-1 overflow-y-auto p-3 sm:p-4 space-y-2.5 sm:space-y-3 bg-gray-50" style="padding-bottom: max(1rem, env(safe-area-inset-bottom));">
                @if (isLoadingMessages) {
                  <div class="flex items-center justify-center py-6 sm:py-8">
                    <div class="animate-spin rounded-full h-5 w-5 sm:h-6 sm:w-6 border-b-2 border-purple-600"></div>
                  </div>
                } @else if (messages.length === 0) {
                  <div class="flex flex-col items-center justify-center py-6 sm:py-8 text-gray-400">
                    <svg class="w-8 h-8 sm:w-10 sm:h-10 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <p class="text-[10px] sm:text-xs">No hay mensajes aún</p>
                  </div>
                } @else {
                  @for (message of messages; track message.id) {
                    <div [class]="message.senderType === 'CLIENT' ? 'flex justify-end' : 'flex justify-start'">
                      <div [class]="message.senderType === 'CLIENT'
                        ? 'bg-purple-600 text-white rounded-2xl rounded-br-md px-2.5 sm:px-3 py-1.5 sm:py-2 max-w-[85%] sm:max-w-[80%]'
                        : 'bg-white border border-gray-200 rounded-2xl rounded-bl-md px-2.5 sm:px-3 py-1.5 sm:py-2 max-w-[85%] sm:max-w-[80%] shadow-sm'">
                        @if (message.senderType === 'EMPLOYEE' && message.sender) {
                          <p class="text-[10px] sm:text-xs font-medium text-purple-600 mb-0.5 sm:mb-1">
                            {{ message.sender.name }} {{ message.sender.lastName }}
                          </p>
                        }
                        <p [class]="message.senderType === 'CLIENT' ? 'text-xs sm:text-sm' : 'text-xs sm:text-sm text-gray-900'">{{ message.content }}</p>
                        <p [class]="message.senderType === 'CLIENT'
                          ? 'text-[9px] sm:text-[10px] text-purple-200 mt-0.5 sm:mt-1 text-right'
                          : 'text-[9px] sm:text-[10px] text-gray-400 mt-0.5 sm:mt-1'">
                          {{ formatMessageTime(message.createdAt) }}
                        </p>
                      </div>
                    </div>
                  }
                }
              </div>

              <!-- Message Input - Fixed positioning for mobile with safe area -->
              <div class="p-3 sm:p-3 border-t border-gray-200 bg-white flex-shrink-0"
                   style="padding-bottom: max(1rem, calc(env(safe-area-inset-bottom) + 0.75rem));">
                <div class="flex gap-2 sm:gap-2">
                  <input type="text"
                         [(ngModel)]="newMessage"
                         (keyup.enter)="sendMessage()"
                         placeholder="Escribe un mensaje..."
                         [disabled]="isSendingMessage"
                         class="flex-1 px-3 sm:px-3 py-3 sm:py-2 border border-gray-300 rounded-lg text-base sm:text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                         style="font-size: 16px;">
                  <button (click)="sendMessage()"
                          [disabled]="!newMessage.trim() || isSendingMessage"
                          class="px-4 sm:px-3 py-3 sm:py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white text-sm sm:text-sm font-medium rounded-lg transition-colors flex items-center gap-1 flex-shrink-0">
                    @if (isSendingMessage) {
                      <div class="animate-spin rounded-full h-4 w-4 sm:h-4 sm:w-4 border-b-2 border-white"></div>
                    } @else {
                      <svg class="w-4 h-4 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                      </svg>
                    }
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer - Solo visible en tab "Detalles" en móvil, siempre visible en desktop -->
          <div [class]="activeTab === 'details' ? 'block' : 'hidden md:flex'"
               class="px-4 sm:px-6 py-3 sm:py-4 border-t border-gray-100 flex-col-reverse sm:flex-row justify-end gap-2 sm:gap-3 flex-shrink-0">
            <button (click)="closeModal()"
                    class="w-full sm:w-auto px-4 py-2 rounded-md text-sm font-medium bg-gray-900 hover:bg-gray-800 text-white transition-colors">
              Cerrar
            </button>
            <button (click)="cancelarIncidencia()"
                    class="w-full sm:w-auto px-4 py-2 rounded-md text-sm font-medium bg-red-600 hover:bg-red-700 text-white transition-colors">
              Cancelar Incidencia
            </button>
          </div>
        }

      </div>
    </div>
  }

  <!-- Notification Detail Modal -->
  <app-notification-detail-modal
    [notification]="selectedNotification"
    [isOpen]="isNotificationDetailModalOpen"
    (close)="closeNotificationDetailModal()"
    (markAsRead)="onMarkNotificationAsRead($event)"
    (delete)="onDeleteNotification($event)">
  </app-notification-detail-modal>
</div>
