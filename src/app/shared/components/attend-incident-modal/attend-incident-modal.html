<!-- Modal Backdrop -->
@if (isOpen) {
<div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 animate-fade-in"
  (click)="handleBackdropClick($event)">
  <!-- Modal Container - Full height and wider -->
  <div
    class="bg-[var(--card-bg)] rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col animate-scale-in border border-[var(--card-border)]">

    @if (incidentData) {
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-[var(--border-primary)] flex-shrink-0">
      <div>
        <h2 class="text-xl font-bold text-[var(--text-primary)]">Atender Incidencia</h2>
        <p class="text-sm text-[var(--text-tertiary)]">{{ incidentData.name }}</p>
      </div>
      <button (click)="closeModal()"
        class="text-[var(--text-tertiary)] hover:text-[var(--text-primary)] transition-colors p-2 hover:bg-[var(--bg-hover)] rounded-lg">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Mobile Tabs - Only visible on mobile -->
    <div class="md:hidden border-b border-[var(--border-primary)] bg-[var(--card-bg)] flex-shrink-0">
      <div class="flex">
        <button (click)="switchTab('details')"
          [class]="activeTab === 'details'
                      ? 'flex-1 px-6 py-4 text-sm font-semibold text-purple-600 border-b-2 border-purple-600 bg-purple-50/50 transition-all'
                      : 'flex-1 px-6 py-4 text-sm font-medium text-[var(--text-tertiary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-hover)] border-b-2 border-transparent transition-all'">
          <div class="flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span>Detalles</span>
          </div>
        </button>
        <button (click)="switchTab('chat')"
          [class]="activeTab === 'chat'
                      ? 'flex-1 px-6 py-4 text-sm font-semibold text-purple-600 border-b-2 border-purple-600 bg-purple-50/50 transition-all'
                      : 'flex-1 px-6 py-4 text-sm font-medium text-[var(--text-tertiary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-hover)] border-b-2 border-transparent transition-all'">
          <div class="flex items-center justify-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            <span>Chat</span>
          </div>
        </button>
      </div>
    </div>

    <!-- Body - Split into two columns -->
    <div class="flex-1 overflow-hidden flex">

      <!-- Left Column - Ticket Details -->
      <div
        [class]="activeTab === 'details' ? 'w-full md:w-1/2 md:border-r border-[var(--border-primary)] overflow-y-auto p-6 space-y-6 animate-slide-in-left' : 'hidden md:block md:w-1/2 md:border-r border-[var(--border-primary)] overflow-y-auto p-6 space-y-6'">
        <div>
          <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-5">Ticket Inicial</h3>

          <!-- Type and Alert Level -->
          <div class="flex items-start justify-between gap-4 mb-6 pb-6 border-b border-[var(--border-primary)]">
            <div>
              <label class="text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wide block mb-2">Tipo de
                Incidencia</label>
              <span
                class="inline-flex items-center px-3 py-1.5 rounded-md text-sm font-medium border border-purple-600 dark:border-purple-400 text-purple-600 dark:text-purple-400">
                {{ tipoLabel }}
              </span>
            </div>
            <div class="flex flex-col items-end">
              <label class="text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wide mb-2">Nivel de
                Alerta</label>
              <div class="flex items-center gap-1.5 border border-gray-400 dark:border-gray-500 rounded-md px-3 py-1.5">
                <div class="w-3 h-3 rounded-full"
                  [class]="incidentData.alertLevel === 'RED' ? 'bg-red-500' : 'bg-[var(--text-muted)]'"></div>
                <div class="w-3 h-3 rounded-full"
                  [class]="incidentData.alertLevel === 'ORANGE' ? 'bg-orange-500' : 'bg-[var(--text-muted)]'"></div>
                <div class="w-3 h-3 rounded-full"
                  [class]="incidentData.alertLevel === 'YELLOW' ? 'bg-yellow-400' : 'bg-[var(--text-muted)]'"></div>
                <div class="w-3 h-3 rounded-full"
                  [class]="incidentData.alertLevel === 'GREEN' ? 'bg-green-500' : 'bg-[var(--text-muted)]'"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Status Selector -->
        <div class="pb-6 border-b border-[var(--border-primary)]">
          <label
            class="text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wide block mb-3">Estado</label>
          <select [(ngModel)]="selectedStatus" (change)="updateStatus()"
            class="w-full px-4 py-2.5 border border-[var(--card-border)] rounded-lg text-sm bg-[var(--card-bg)] text-[var(--text-primary)] focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
            <option value="PENDING">Pendiente</option>
            <option value="IN_PROGRESS">En Progreso</option>
            <option value="RESOLVED">Resuelto</option>
          </select>
        </div>

        <!-- Reopen Request Alert -->
        @if (pendingReopenRequestId && incidentData.pendingReopenRequest) {
        <div class="pb-6 border-b border-[var(--border-primary)]">
          <div class="bg-amber-50 dark:bg-amber-900/20 border-2 border-amber-400 dark:border-amber-600 rounded-xl p-4">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-10 h-10 rounded-full bg-amber-500 flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </div>
              <div class="flex-1">
                <h4 class="text-sm font-bold text-amber-900 dark:text-amber-300 mb-1">
                  游댃 Solicitud de Reapertura Pendiente
                </h4>
                <p class="text-xs text-amber-800 dark:text-amber-400 mb-2">
                  El cliente <strong>{{ incidentData.pendingReopenRequest.requestedBy?.name || 'desconocido'
                    }}</strong> ha solicitado reabrir esta incidencia.
                </p>
                <p
                  class="text-xs text-amber-700 dark:text-amber-500 italic mb-3 bg-amber-100 dark:bg-amber-900/40 p-2 rounded border-l-4 border-amber-500">
                  "{{ incidentData.pendingReopenRequest.clientReason }}"
                </p>
                <button (click)="openReviewReopenModal()"
                  class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white text-sm font-semibold rounded-lg transition-colors shadow-md hover:shadow-lg flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                  </svg>
                  Revisar Solicitud
                </button>
              </div>
            </div>
          </div>
        </div>
        }

        <!-- Description -->
        <div class="pb-6 border-b border-[var(--border-primary)]">
          <label
            class="text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wide block mb-3">Descripci칩n</label>
          <div class="bg-[var(--bg-tertiary)] rounded-lg p-4 border border-[var(--card-border)]">
            <p class="text-sm text-[var(--text-secondary)] leading-relaxed">{{ incidentData.description || 'Sin
              descripci칩n' }}</p>
          </div>
        </div>

        <!-- Info Grid -->
        <div class="pb-6 border-b border-[var(--border-primary)]">
          <label class="text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wide block mb-4">Informaci칩n
            del Ticket</label>
          <div class="grid grid-cols-2 gap-x-4 gap-y-4">
            <div class="bg-[var(--bg-tertiary)] rounded-lg p-3 border border-[var(--card-border)]">
              <label
                class="text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wide block mb-1.5">Referencia</label>
              <p class="text-sm text-[var(--text-primary)] font-mono font-medium">{{ incidentData.ProducReferenceId }}
              </p>
            </div>
            <div class="bg-[var(--bg-tertiary)] rounded-lg p-3 border border-[var(--card-border)]">
              <label class="text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wide block mb-1.5">Fecha
                creaci칩n</label>
              <p class="text-sm text-[var(--text-primary)] font-medium">{{ formatDateTime(incidentData.createdAt) }}</p>
            </div>
            <div class="bg-[var(--bg-tertiary)] rounded-lg p-3 border border-[var(--card-border)]">
              <label class="text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wide block mb-1.5">Creado
                por</label>
              <p class="text-sm text-[var(--text-primary)] font-medium">{{ createdByName }}</p>
            </div>
            <div class="bg-[var(--bg-tertiary)] rounded-lg p-3 border border-[var(--card-border)]">
              <label
                class="text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wide block mb-1.5">Asignado
                a</label>
              <p class="text-sm text-[var(--text-primary)] font-medium">{{ assignedEmployeeName }}</p>
            </div>
          </div>
        </div>

        <!-- Im치genes Iniciales -->
        @if (initialImages.length > 0) {
        <div>
          <label class="text-xs font-medium text-[var(--text-tertiary)] uppercase tracking-wide block mb-4">
            Im치genes Iniciales ({{ initialImages.length }})
          </label>
          <div class="relative">
            <!-- Carousel Container -->
            <div
              class="relative rounded-lg overflow-hidden border border-[var(--card-border)] aspect-video bg-[var(--card-bg)] group">
              @if ((initialImages[currentInitialImageIndex].url | secureImage | async); as imageUrl) {
              <img [src]="imageUrl" [alt]="initialImages[currentInitialImageIndex].originalName"
                class="w-full h-full object-cover cursor-pointer transition-transform duration-300 group-hover:scale-105"
                style="image-rendering: -webkit-optimize-contrast;"
                (click)="openLightbox(currentInitialImageIndex, 'initial')" title="Click para ver imagen completa">
              }

              <!-- Hover Overlay - Ver imagen -->
              <div
                class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all duration-300 flex items-center justify-center pointer-events-none z-10">
                <div
                  class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-white/95 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2">
                  <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  <span class="text-sm font-semibold text-gray-700">Ver imagen completa</span>
                </div>
              </div>

              <!-- Image Counter -->
              <div
                class="absolute top-3 right-3 bg-black/70 text-white text-xs font-medium px-2.5 py-1 rounded-md z-30 pointer-events-none">
                {{ currentInitialImageIndex + 1 }} / {{ initialImages.length }}
              </div>

              <!-- Navigation Arrows -->
              @if (initialImages.length > 1) {
              @if (currentInitialImageIndex > 0) {
              <button (click)="previousInitialImage($event)" (mouseenter)="$event.stopPropagation()"
                class="absolute left-3 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white text-gray-800 p-2.5 rounded-full shadow-lg transition-all duration-200 hover:scale-110 z-50 pointer-events-auto">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              }
              @if (currentInitialImageIndex < initialImages.length - 1) { <button (click)="nextInitialImage($event)"
                (mouseenter)="$event.stopPropagation()"
                class="absolute right-3 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white text-gray-800 p-2.5 rounded-full shadow-lg transition-all duration-200 hover:scale-110 z-50 pointer-events-auto">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7" />
                </svg>
                </button>
                }
                }
            </div>
          </div>
        </div>
        }

        <!-- Evidencia Adicional -->
        @if (additionalImages.length > 0) {
        <div [class.mt-6]="initialImages.length > 0">
          <label
            class="text-xs font-medium text-amber-700 dark:text-amber-400 uppercase tracking-wide block mb-4 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Evidencia Adicional ({{ additionalImages.length }})
          </label>
          <div class="relative">
            <!-- Carousel Container -->
            <div
              class="relative rounded-lg overflow-hidden border-2 border-amber-300 dark:border-amber-600 aspect-video bg-[var(--card-bg)] group">
              @if ((additionalImages[currentAdditionalImageIndex].url | secureImage | async); as imageUrl) {
              <img [src]="imageUrl" [alt]="additionalImages[currentAdditionalImageIndex].originalName"
                class="w-full h-full object-cover cursor-pointer transition-transform duration-300 group-hover:scale-105"
                style="image-rendering: -webkit-optimize-contrast;"
                (click)="openLightbox(currentAdditionalImageIndex, 'additional')"
                title="Click para ver imagen completa">
              }

              <!-- Hover Overlay - Ver imagen -->
              <div
                class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all duration-300 flex items-center justify-center pointer-events-none z-10">
                <div
                  class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-white/95 px-4 py-2 rounded-lg shadow-lg flex items-center gap-2">
                  <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  <span class="text-sm font-semibold text-gray-700">Ver imagen completa</span>
                </div>
              </div>

              <!-- Image Counter -->
              <div
                class="absolute top-3 right-3 bg-amber-600/90 text-white text-xs font-medium px-2.5 py-1 rounded-md z-30 pointer-events-none">
                {{ currentAdditionalImageIndex + 1 }} / {{ additionalImages.length }}
              </div>

              <!-- Navigation Arrows -->
              @if (additionalImages.length > 1) {
              @if (currentAdditionalImageIndex > 0) {
              <button (click)="previousAdditionalImage($event)" (mouseenter)="$event.stopPropagation()"
                class="absolute left-3 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white text-gray-800 p-2.5 rounded-full shadow-lg transition-all duration-200 hover:scale-110 z-50 pointer-events-auto">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              }
              @if (currentAdditionalImageIndex < additionalImages.length - 1) { <button
                (click)="nextAdditionalImage($event)" (mouseenter)="$event.stopPropagation()"
                class="absolute right-3 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white text-gray-800 p-2.5 rounded-full shadow-lg transition-all duration-200 hover:scale-110 z-50 pointer-events-auto">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7" />
                </svg>
                </button>
                }
                }
            </div>
          </div>
        </div>
        }

        <!-- No images message -->
        @if (initialImages.length === 0 && additionalImages.length === 0) {
        <div class="bg-[var(--bg-tertiary)] rounded-lg p-4 text-center">
          <p class="text-sm text-[var(--text-tertiary)]">No hay im치genes adjuntas</p>
        </div>
        }

      </div>

      <!-- Right Column - Chat -->
      <div
        [class]="activeTab === 'chat' ? 'w-full md:w-1/2 flex flex-col animate-slide-in-right' : 'hidden md:flex md:w-1/2 flex-col'">
        <!-- Chat Header - More professional -->
        <div class="px-4 md:px-8 py-3 md:py-5 border-b border-[var(--border-primary)] bg-[var(--card-bg)]">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-sm md:text-base font-semibold text-[var(--text-primary)] tracking-tight">Conversaci칩n con
                el Cliente</h3>
              <p class="text-[10px] md:text-xs text-[var(--text-tertiary)] mt-0.5 md:mt-1 flex items-center gap-1">
                <span class="w-1.5 h-1.5 md:w-2 md:h-2 bg-green-500 rounded-full"></span>
                <span>Activo</span>
              </p>
            </div>
            <!-- Optional: Connection status indicator -->
            @if (isConnected) {
            <div
              class="hidden md:flex items-center gap-2 px-3 py-1.5 border border-gray-400 dark:border-gray-500 rounded-lg">
              <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
              <span class="text-xs font-medium text-green-700 dark:text-green-400">En l칤nea</span>
            </div>
            }
          </div>
        </div>

        <!-- Messages Container - More spacious -->
        <div id="chat-messages"
          class="flex-1 overflow-y-auto px-3 md:px-8 py-3 md:py-6 space-y-2 md:space-y-4 bg-[var(--bg-tertiary)]"
          style="padding-bottom: max(1.5rem, calc(env(safe-area-inset-bottom) + 1rem));">
          @if (isLoadingMessages) {
          <div class="flex items-center justify-center py-12 md:py-20">
            <div class="flex flex-col items-center gap-2 md:gap-3">
              <div class="animate-spin rounded-full h-8 w-8 md:h-10 md:w-10 border-b-2 border-purple-600"></div>
              <p class="text-xs md:text-sm text-[var(--text-tertiary)]">Cargando mensajes...</p>
            </div>
          </div>
          } @else if (messages.length === 0) {
          <div class="flex flex-col items-center justify-center py-16 md:py-24">
            <div
              class="w-14 h-14 md:w-20 md:h-20 rounded-2xl bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 flex items-center justify-center mb-3 md:mb-5">
              <svg class="w-7 h-7 md:w-10 md:h-10 text-purple-600 opacity-60" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
            </div>
            <h4 class="text-sm md:text-base font-semibold text-[var(--text-primary)] mb-1 md:mb-2">Sin mensajes</h4>
            <p class="text-xs md:text-sm text-[var(--text-tertiary)]">Inicia la conversaci칩n con el cliente</p>
          </div>
          } @else {
          @for (message of messages; track message.id) {
          @let isEmployeeMsg = message.senderType === 'EMPLOYEE' || message.messageType === 'REQUEST_IMAGES' ||
          message.messageType === 'SYSTEM' || message.content?.includes('Por favor, sube im치genes');

          <div
            [class]="isEmployeeMsg ? 'flex justify-end items-end gap-1.5 md:gap-3' : 'flex justify-start items-end gap-1.5 md:gap-3'">
            <!-- Avatar for CLIENT messages (solo para mensajes de clientes reales) -->
            @if (!isEmployeeMsg && message.senderType === 'CLIENT') {
            @if (getClientProfilePicture(message); as profilePic) {
            <img [src]="profilePic" [alt]="message.sender?.name"
              class="w-6 h-6 md:w-8 md:h-8 rounded-full object-cover border border-purple-200 flex-shrink-0">
            } @else {
            <div
              class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-[10px] md:text-xs font-semibold flex-shrink-0">
              {{ message.sender ? (message.sender.name.charAt(0) + message.sender.lastName.charAt(0)).toUpperCase() :
              'C' }}
            </div>
            }
            }

            <div class="flex flex-col" [class.items-end]="isEmployeeMsg" [class.items-start]="!isEmployeeMsg">
              <!-- Sender name for CLIENT (solo para mensajes de clientes reales) -->
              @if (!isEmployeeMsg && message.senderType === 'CLIENT' && message.sender) {
              <p
                class="text-[10px] md:text-xs font-semibold text-[var(--text-secondary)] mb-1 md:mb-1.5 px-0.5 md:px-1">
                {{ message.sender.name }} {{ message.sender.lastName }}
              </p>
              }

              <!-- Message bubble -->
              <div
                [class]="isEmployeeMsg
                        ? 'bg-purple-600 text-white rounded-2xl rounded-br-sm px-3 py-2 md:px-5 md:py-3.5 min-w-[120px] md:min-w-[180px] max-w-[85%] md:max-w-[85%] shadow-md'
                        : 'bg-[var(--card-bg)] border border-[var(--border-primary)] rounded-2xl rounded-bl-sm px-3 py-2 md:px-5 md:py-3.5 min-w-[120px] md:min-w-[180px] max-w-[85%] md:max-w-[85%] shadow-sm'">
                <p
                  [class]="isEmployeeMsg ? 'text-[13px] md:text-[15px] leading-relaxed break-words' : 'text-[13px] md:text-[15px] text-[var(--text-primary)] leading-relaxed break-words'">
                  {{ message.content }}</p>
                <div class="flex items-center justify-end gap-1 mt-0.5 md:mt-1">
                  <p [class]="message.senderType === 'EMPLOYEE'
                                    ? 'text-[9px] md:text-[10px] text-purple-200'
                                    : 'text-[9px] md:text-[10px] text-[var(--text-muted)]'">
                    {{ formatMessageTime(message.createdAt) }}
                  </p>
                  @if (message.senderType === 'EMPLOYEE') {
                  @if (message.isRead) {
                  <!-- Double Check Blue (Read) -->
                  <div class="flex -space-x-1">
                    <svg class="w-3 h-3 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <svg class="w-3 h-3 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                  </div>
                  } @else {
                  <!-- Single Check (Sent) -->
                  <svg class="w-3 h-3 text-purple-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                  </svg>
                  }
                  }
                </div>
              </div>

              <!-- Timestamp -->
              <!-- The original timestamp was here, but it's now moved inside the message bubble div for better layout with read status. -->
              <!-- <p class="text-[9px] md:text-[11px] text-[var(--text-muted)] mt-1 md:mt-1.5 px-0.5 md:px-1">
                        {{ formatMessageTime(message.createdAt) }}
                      </p> -->
            </div>

            <!-- Avatar for EMPLOYEE messages (incluye REQUEST_IMAGES y SYSTEM) -->
            @if (isEmployeeMsg) {
            @if (currentEmployeePhoto) {
            <img [src]="currentEmployeePhoto" alt="T칰"
              class="w-6 h-6 md:w-8 md:h-8 rounded-full object-cover border border-purple-200 flex-shrink-0">
            } @else {
            <div
              class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-gradient-to-br from-gray-600 to-gray-700 flex items-center justify-center text-white text-[10px] md:text-xs font-semibold flex-shrink-0">
              T칔
            </div>
            }
            }
          </div>
          }
          }

          <!-- Typing Indicator -->
          @if (typingUsers.size > 0) {
          <div class="flex justify-start items-end gap-1.5 md:gap-3 px-1">
            <div
              class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white text-[10px] md:text-xs font-semibold flex-shrink-0">
              C
            </div>
            <div
              class="bg-[var(--card-bg)] border border-[var(--border-primary)] rounded-2xl rounded-bl-sm px-4 py-3 shadow-sm flex items-center gap-2">
              <div class="flex gap-1">
                <span class="w-2 h-2 bg-purple-600 rounded-full animate-bounce" style="animation-delay: 0ms;"></span>
                <span class="w-2 h-2 bg-purple-600 rounded-full animate-bounce" style="animation-delay: 150ms;"></span>
                <span class="w-2 h-2 bg-purple-600 rounded-full animate-bounce" style="animation-delay: 300ms;"></span>
              </div>
              <span class="text-xs text-[var(--text-tertiary)]">Escribiendo...</span>
            </div>
          </div>
          }
        </div>

        <!-- Message Input - Professional design with safe area -->
        <div class="px-3 md:px-8 py-4 md:py-5 border-t border-[var(--border-primary)] bg-[var(--card-bg)]"
          style="padding-bottom: max(1rem, calc(env(safe-area-inset-bottom) + 0.75rem));">
          @if (isChatDisabled) {
          <!-- Chat disabled message -->
          <div class="flex items-center justify-center py-2 md:py-4">
            <div
              class="flex items-center gap-2 md:gap-3 px-3 md:px-6 py-2 md:py-3 bg-[var(--bg-tertiary)] border border-[var(--border-primary)] rounded-xl">
              <svg class="w-4 h-4 md:w-5 md:h-5 text-[var(--text-tertiary)]" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
              <div>
                <p class="text-xs md:text-sm font-semibold text-[var(--text-primary)]">Chat deshabilitado</p>
                <p class="text-[10px] md:text-xs text-[var(--text-tertiary)]">La incidencia ha sido resuelta</p>
              </div>
            </div>
          </div>
          } @else {
          <!-- Request Images Options -->
          @if (showRequestImagesOptions) {
          <div
            class="mb-3 md:mb-4 p-3 md:p-5 bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl md:rounded-2xl shadow-sm">
            <div class="flex items-center justify-between mb-3 md:mb-4">
              <div class="flex items-center gap-2 md:gap-3">
                <div
                  class="w-8 h-8 md:w-10 md:h-10 rounded-lg md:rounded-xl bg-amber-100 flex items-center justify-center">
                  <svg class="w-4 h-4 md:w-5 md:h-5 text-amber-600" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
                <div>
                  <h4 class="text-xs md:text-sm font-semibold text-amber-900">Solicitar Evidencia</h4>
                  <p class="text-[10px] md:text-xs text-amber-700 mt-0.5 hidden md:block">El cliente podr치 subir
                    im치genes durante el tiempo especificado</p>
                </div>
              </div>
              <button (click)="toggleRequestImagesOptions()"
                class="text-amber-600 hover:text-amber-700 p-1.5 md:p-2 hover:bg-amber-100 rounded-lg transition-all">
                <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            <div class="flex items-center gap-2 md:gap-3">
              <div class="flex-1">
                <label class="text-[10px] md:text-xs font-medium text-amber-800 block mb-1.5 md:mb-2">Tiempo
                  permitido</label>
                <select [(ngModel)]="requestImagesHours"
                  class="w-full px-3 md:px-4 py-2 md:py-2.5 border border-amber-200 rounded-lg md:rounded-xl text-xs md:text-sm bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent shadow-sm">
                  <option [value]="6">6 horas</option>
                  <option [value]="12">12 horas</option>
                  <option [value]="24">24 horas</option>
                  <option [value]="48">48 horas</option>
                  <option [value]="72">72 horas</option>
                </select>
              </div>
              <div class="pt-4 md:pt-6">
                <button (click)="requestImages()" [disabled]="isRequestingImages"
                  class="px-3 md:px-6 py-2 md:py-2.5 bg-amber-600 hover:bg-amber-700 disabled:opacity-50 disabled:cursor-not-allowed text-white text-xs md:text-sm font-semibold rounded-lg md:rounded-xl transition-colors flex items-center gap-1.5 md:gap-2 shadow-sm">
                  <span>Solicitar</span>
                </button>
              </div>
            </div>
          </div>
          }

          <!-- Message Input Area -->
          <div class="flex items-end gap-2 md:gap-3">
            <!-- Request Images Button -->
            <button (click)="toggleRequestImagesOptions()"
              [class]="showRequestImagesOptions ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 border-amber-200 dark:border-amber-700' : 'bg-[var(--bg-tertiary)] text-[var(--text-tertiary)] border-[var(--border-primary)] hover:bg-[var(--bg-hover)]'"
              class="p-3 md:p-3 rounded-lg md:rounded-xl transition-all border flex-shrink-0"
              title="Solicitar evidencia fotogr치fica">
              <svg class="w-5 h-5 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </button>

            <!-- Message Input -->
            <div class="flex-1 relative">
              <input type="text" [(ngModel)]="newMessage" (input)="onMessageInput($event)" (keyup.enter)="sendMessage()"
                placeholder="Escribe un mensaje..." [disabled]="isSendingMessage"
                class="w-full px-3 md:px-5 py-3 md:py-3.5 border border-[var(--input-border)] rounded-xl md:rounded-2xl text-base md:text-sm bg-[var(--input-bg)] text-[var(--input-text)] placeholder-[var(--input-placeholder)] focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all"
                style="font-size: 16px;">
            </div>

            <!-- Send Button -->
            <button (click)="sendMessage()" [disabled]="!newMessage.trim() || isSendingMessage"
              class="px-4 md:px-6 py-3 md:py-3.5 bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white text-sm md:text-sm font-semibold rounded-xl md:rounded-2xl transition-all flex items-center gap-1.5 md:gap-2 shadow-sm flex-shrink-0">
              <svg class="w-5 h-5 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
              <span class="hidden md:inline">Enviar</span>
            </button>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Footer - Hidden on mobile -->
    <div class="hidden md:flex px-6 py-4 border-t border-[var(--border-primary)] justify-end gap-3 flex-shrink-0">
      <button (click)="closeModal()"
        class="px-4 py-2 rounded-lg text-sm font-medium bg-[var(--bg-tertiary)] hover:bg-[var(--bg-hover)] text-[var(--text-secondary)] transition-colors">
        Cerrar
      </button>
    </div>
    } @else {
    <div class="flex items-center justify-center flex-1">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
    </div>
    }

  </div>
</div>

<!-- Lightbox for full-size image -->
@if (isLightboxOpen) {
<div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 animate-fade-in"
  (click)="closeLightbox()">
  <!-- Close Button -->
  <button (click)="closeLightbox()"
    class="absolute top-4 right-4 text-white hover:text-gray-300 p-2 hover:bg-white/10 rounded-full transition-all z-10">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>

  <!-- Image Container -->
  <div class="relative w-full h-full flex items-center justify-center p-4" (click)="$event.stopPropagation()">
    @if (lightboxImageType === 'initial' && initialImages.length > 0) {
    @if ((initialImages[lightboxImageIndex].url | secureImage | async); as imageUrl) {
    @if (imageUrl) {
    <img [src]="imageUrl" [alt]="initialImages[lightboxImageIndex].originalName"
      class="w-auto h-auto max-w-[90vw] max-h-[90vh] object-contain shadow-2xl"
      style="image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges;"
      (click)="$event.stopPropagation()">
    }
    }
    <!-- Image Counter -->
    @if (initialImages.length > 1) {
    <div
      class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/70 text-white text-sm font-medium px-4 py-2 rounded-full">
      {{ lightboxImageIndex + 1 }} / {{ initialImages.length }}
    </div>
    }
    } @else if (lightboxImageType === 'additional' && additionalImages.length > 0) {
    @if ((additionalImages[lightboxImageIndex].url | secureImage | async); as imageUrl) {
    @if (imageUrl) {
    <img [src]="imageUrl" [alt]="additionalImages[lightboxImageIndex].originalName"
      class="w-auto h-auto max-w-[90vw] max-h-[90vh] object-contain shadow-2xl"
      style="image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges;"
      (click)="$event.stopPropagation()">
    }
    }
    <!-- Image Counter -->
    @if (additionalImages.length > 1) {
    <div
      class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-amber-600/90 text-white text-sm font-medium px-4 py-2 rounded-full">
      {{ lightboxImageIndex + 1 }} / {{ additionalImages.length }}
    </div>
    }
    }
  </div>
</div>

<!-- Review Reopen Modal -->
@if (isReviewReopenModalOpen && pendingReopenRequestId) {
<app-review-reopen-modal [requestId]="pendingReopenRequestId" (closeModal)="closeReviewReopenModal()"
  (reviewSubmitted)="onReopenReviewSubmitted()">
</app-review-reopen-modal>
}
}
}